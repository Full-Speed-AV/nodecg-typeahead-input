<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-material/paper-material.html">

<dom-module id="nodecg-typeahead-suggestions">
	<template>
		<style>
			:host {
				display: block;
				box-sizing: border-box;
				font-family: 'Roboto', 'Noto', sans-serif;
			}

			paper-material {
				left: 0;
				right: 0;
				position: absolute;
				z-index: 10;
			}

			paper-item {
				cursor: pointer;
			}

			.iron-selected {
				background: #E0E0E0;
			}
		</style>

		<paper-material id="material">
			<paper-menu on-iron-select="_itemSelect">
				<template is="dom-repeat" items="{{_suggestions}}">
					<paper-item on-mouseover="_selecton" on-tap="_select">
						<span>{{item}}</span>
					</paper-item>
				</template>
			</paper-menu>
		</paper-material>
	</template>
</dom-module>

<script>
	Polymer({
		is: 'nodecg-typeahead-suggestions',

		properties: {

			/**
			 * Internal variable holding all matched suggestions.
			 */
			_suggestions: {
				type: Array,
				value: [],
				observer: '_suggestionsChanged'
			}
		},

		_suggestionsChanged: function (newVal) {
			this.$.material.style.display = newVal.length > 0 ? 'block' : 'none';
		},

		ready: function () {
			window.dispatchEvent(new CustomEvent('suggestionsReady'));
			window.suggestionsReady = true;

			// Hide suggestions when clicking on an empty part of the suggestions iframe.
			window.addEventListener('click', function (e) {
				if (e.target.tagName === 'HTML') {
					this._suggestions = [];
				}
			}.bind(this));
		},

		_itemSelect: function (e, detail) {
			this._ntiRef.fire('suggestion-select', detail);
		},

		/**
		 * Callback on mouseover event on paper-item
		 */
		_selecton: function (e) {
			var suggestionsMenu = this.querySelector('paper-menu');
			var selectedItem = e.currentTarget;
			var index = Number(suggestionsMenu.indexOf(selectedItem));
			suggestionsMenu.select(index);
			this._paperInputRef.$.input.focus();
		},

		/**
		 * Callback on click event on paper-item
		 */
		_select: function (e) {
			var suggestionsMenu = this.querySelector('paper-menu');
			var selectedItem = e.currentTarget;
			var index = Number(suggestionsMenu.indexOf(selectedItem));
			this._ntiRef.value = this._suggestions[index];
			this._suggestions = [];
			this._ntiRef.fire('suggestion-confirm', e.target);
			window.frameElement.style.display = 'none';
			e.stopPropagation();
		}
	});
</script>
